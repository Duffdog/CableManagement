@page "/"
@inject HttpClient Http

<h3>Dimensionnement de chemin de câble</h3>

@if (_cableTypes == null)
{
    <p>Chargement des données...</p>
}
else
{
    <button class="btn btn-success mb-3" @onclick="AjouterCable">Ajouter un câble</button>
    <EditForm Model="@this">
        <div class="card">
            <div class="card-body">
                @foreach (var (cable, idx) in _cables.Select((c, i) => (c, i)))
                {
                    <div class="row mb-2 align-items-end" key="@idx">
                        <div class="col-md-3">
                            <label>Type</label>
                            <select class="form-select" @onchange="e => OnTypeChanged(e, idx)">
                                <option disabled selected value>-- Type --</option>
                                @foreach (var type in _cableTypes)
                                {
                                    <option value="@type.Type" selected="@(cable.Type == type.Type)">
                                        @type.Type
                                    </option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>Référence</label>
                            <select class="form-select" @onchange="e => OnReferenceChanged(e, idx)" disabled="@string.IsNullOrEmpty(cable.Type)">
                                <option disabled selected value>-- Référence --</option>
                                @foreach (var reference in _cableTypes.FirstOrDefault(t => t.Type == cable.Type)?.References ?? new List<CableReference>())
                                {
                                    <option value="@reference.Designation" selected="@(cable.Designation == reference.Designation)">
                                        @reference.Designation
                                    </option>
                                }
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label>Diamètre (mm)</label>
                            <input class="form-control" value="@cable.DiameterMm" readonly />
                        </div>
                        <div class="col-md-2">
                            <label>Quantité</label>
                            <input type="number" class="form-control" min="1" @bind="cable.Quantity" />
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-danger" @onclick="() => SupprimerCable(idx)" disabled="@(_cables.Count == 1)">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </EditForm>

    <button class="btn btn-primary mt-3" @onclick="CalculerEncombrement">Calculer encombrement</button>

    @if (_occupancy > 0)
    {
        <div class="mt-4">
            <h5>Résultats</h5>
            <p>Encombrement total : <b>@_occupancy.ToString("0.00") cm²</b></p>
            <h6>Disposition (vue en coupe)</h6>
            <svg width="800" height="120" style="border:1px solid #ccc; background:#f8f9fa">
                @{
                    int posX = 20;
                    foreach (var cable in _cables.Where(c => c.Quantity > 0 && c.DiameterMm > 0))
                    {
                        for (int i = 0; i < cable.Quantity; i++)
                        {
                            <circle cx="@posX" cy="60" r="@(cable.DiameterMm / 2)" fill="#0d6efd" stroke="#000" stroke-width="0.5" />
                            posX += (int)cable.DiameterMm + 5;
                        }
                    }
                }
            </svg>
        </div>
    }
}

@code {
    // Modèles pour le JSON
    public class CableReference
    {
        public string Designation { get; set; } = string.Empty;
        public double DiameterMm { get; set; }
    }
    public class CableType
    {
        public string Type { get; set; } = string.Empty;
        public List<CableReference>? References { get; set; }
    }
    public class SelectedCable
    {
        public string Type { get; set; } = string.Empty;
        public string Designation { get; set; } = string.Empty;
        public double DiameterMm { get; set; }
        public int Quantity { get; set; } = 1;
    }

    private List<CableType>? _cableTypes;
    private List<SelectedCable> _cables = new() { new SelectedCable() };
    private double _occupancy;

    protected override async Task OnInitializedAsync()
    {
        _cableTypes = await Http.GetFromJsonAsync<List<CableType>>("sample-data/Cable.json");
    }

    private void AjouterCable()
    {
        _cables.Add(new SelectedCable());
    }

    private void SupprimerCable(int idx)
    {
        if (_cables.Count > 1)
            _cables.RemoveAt(idx);
    }

    private void OnTypeChanged(ChangeEventArgs e, int idx)
    {
        var type = e.Value?.ToString();
        _cables[idx].Type = type!;
        _cables[idx].Designation = null!;
        _cables[idx].DiameterMm = 0;
    }

    private void OnReferenceChanged(ChangeEventArgs e, int idx)
    {
        var designation = e.Value?.ToString();
        _cables[idx].Designation = designation!;
        var cableType = _cableTypes?.FirstOrDefault(t => t.Type == _cables[idx].Type);
        var reference = cableType?.References?.FirstOrDefault(r => r.Designation == designation);
        _cables[idx].DiameterMm = reference?.DiameterMm ?? 0;
    }

    private void CalculerEncombrement()
    {
        // (2r)^2 * quantité = (diamètre)^2 * quantité, puis conversion mm² -> cm²
        _occupancy = _cables
            .Where(c => c.Quantity > 0 && c.DiameterMm > 0)
            .Sum(c => Math.Pow(c.DiameterMm, 2) * c.Quantity) / 100;
    }
}
